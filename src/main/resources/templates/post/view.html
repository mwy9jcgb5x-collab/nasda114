<!-- =========================
  templates/posts/view.html
  (ìµœì¢… í•©ë³¸ - ì „ì²´ ì½”ë“œ)
========================= -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <th:block th:replace="~{layout/header :: head}"></th:block>

    <!-- Swiper -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@12/swiper-bundle.min.css" />
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/sticker.css}">

    <!-- âœ… ìƒì„¸ ì´ë¯¸ì§€: "ì•ˆ ì§¤ë¦¼(contain)" + "ì˜† ìŠ¬ë¼ì´ë“œ ë¹„ì¹¨ ì°¨ë‹¨" + "ë†’ì´ ìë™ ì•ˆì •í™”" -->
    <style>
        /* ========== POST VIEW Swiper: ì˜† ì´ë¯¸ì§€ ë¹„ì¹¨ ì°¨ë‹¨ ========== */
        .post-images {
            margin-top: 18px;
            overflow: hidden; /* âœ… ì˜† ìŠ¬ë¼ì´ë“œ ë¹„ì¹¨ ì°¨ë‹¨ */
        }

        /* Swiper ìì²´ ë°•ìŠ¤ */
        .postImagesSwiper {
            width: 100%;
            max-width: 920px;
            margin: 0 auto;
            border-radius: 20px;
            overflow: hidden; /* âœ… í•µì‹¬ */
            background: var(--color-bg-secondary);
        }

        .postImagesSwiper .swiper-slide {
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background: var(--color-bg-secondary);
        }

        /* ì‹¤ì œ ì´ë¯¸ì§€+ìŠ¤í‹°ì»¤ê°€ ì˜¬ë¼ê°€ëŠ” ë°•ìŠ¤ê°€ ë†’ì´ë¥¼ ë‹´ë‹¹ */
        .post-media-box {
            width: 100%;
            border-radius: 20px;
            overflow: hidden;
            background: var(--color-bg-secondary);
            position: relative;
            /* âœ… ë°˜ì‘í˜• ë†’ì´: ë„ˆë¬´ í¬ì§€ë„ ì‘ì§€ë„ ì•Šê²Œ */
            height: clamp(260px, 62vh, 640px);
        }

        .post-media-box img.post-image {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: contain !important; /* âœ… ì•ˆ ì§¤ë¦¼ */
            background: var(--color-bg-secondary);
        }

        /* ìŠ¤í‹°ì»¤ ë ˆì´ì–´ */
        .post-media-box .sticker-layer {
            position: absolute;
            inset: 0;
            z-index: 10;
            pointer-events: none;
            overflow: hidden;
        }

        /* Swiper UI */
        .postImagesSwiper .swiper-button-prev,
        .postImagesSwiper .swiper-button-next {
            color: rgba(90, 77, 65, 0.7);
        }

        .postImagesSwiper .swiper-pagination {
            bottom: 10px !important;
        }

        .postImagesSwiper .swiper-pagination-bullet {
            background: rgba(90, 77, 65, 0.45);
            opacity: 1;
        }

        .postImagesSwiper .swiper-pagination-bullet-active {
            background: rgba(90, 77, 65, 0.85);
        }
    </style>
</head>

<body class="min-h-screen bg-white">
<!-- ê³µìš© í—¤ë” -->
<div th:replace="~{layout/header :: header}"></div>
<div th:replace="~{layout/header :: searchModal}"></div>
<th:block th:replace="~{layout/header :: commonScript}"></th:block>

<!-- postId data -->
<div data-post-id="" th:data-post-id="${post.id}"></div>

<main class="view-container">

    <div class="post-layout-grid">
        <article class="post-detail">
            <div class="post-detail-header">
                <div>
                    <div class="post-category-badge" th:text="${post.category}">ì¹´í…Œê³ ë¦¬</div>
                    <h1 class="post-detail-title" th:text="${post.title}">ê²Œì‹œë¬¼ ì œëª©</h1>
                </div>
            </div>

            <!-- âœ… ì´ë¯¸ì§€ + ìŠ¤í‹°ì»¤ ë ˆì´ì–´ -->
            <div th:if="${post.imageItems != null and !post.imageItems.isEmpty()}" class="post-images">
                <div class="swiper postImagesSwiper">
                    <div class="swiper-wrapper">
                        <th:block th:each="image : ${post.imageItems}">
                            <div class="swiper-slide">
                                <div class="sticker-canvas post-media-box" th:data-image-id="${image.id}">
                                    <img th:src="@{${image.url}}"
                                         th:alt="${post.title}"
                                         class="post-image select-none">
                                    <div class="sticker-layer" th:data-image-id="${image.id}"></div>
                                </div>
                            </div>
                        </th:block>
                    </div>

                    <div class="swiper-pagination"></div>
                    <div class="swiper-button-prev"></div>
                    <div class="swiper-button-next"></div>
                </div>
            </div>

            <div class="post-detail-header" style="margin: 1rem 2rem;gap: 1rem;padding-bottom: 1rem;">
                <div>
                </div>
                <div class="post-meta-info">
                    <div class="post-author-info">
                        <div class="author-avatar">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                 viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                        </div>
                        <div>
                            <span class="author-name" th:text="${post.author.nickname}">ì‘ì„±ì</span>
                            <span class="post-date" th:text="${#temporals.format(post.createdAt, 'yyyy.MM.dd HH:mm')}">
                  2024.01.01
                </span>
                        </div>
                    </div>

                    <!-- âœ… ê²Œì‹œê¸€ ìˆ˜ì •/ì‚­ì œ: ë™ë£Œ ì½”ë“œ ìœ ì§€ -->
                    <div th:if="${post.isOwner}" class="post-actions">
                        <a th:href="@{/posts/edit/{id}(id=${post.id})}" class="btn-action btn-edit">ìˆ˜ì •</a>
                        <form th:action="@{/posts/{id}/delete(id=${post.id})}" method="post" style="display:inline;">
                            <button type="submit" class="btn-action btn-delete"
                                    onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                                ì‚­ì œ
                            </button>
                        </form>
                    </div>
                </div>
                <div class="post-report-area">
                    <!-- âœ… ê²Œì‹œê¸€ ì‹ ê³  ë²„íŠ¼ (ì¢Œì¸¡ ìƒë‹¨) -->
                    <button type="button" class="btn-post-report" th:attr="data-post-id=${post.id}">
                        âš ï¸ ê²Œì‹œê¸€ ì‹ ê³ 
                    </button>
                </div>
            </div>

            <div class="post-content">
                <p th:text="${post.content}" style="white-space: pre-wrap;">ê²Œì‹œë¬¼ ë‚´ìš©</p>
            </div>

            <div class="view-header">
                <button onclick="window.location.href='/'" class="btn-back-inline">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                         viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="19" y1="12" x2="5" y2="12"></line>
                        <polyline points="12 19 5 12 12 5"></polyline>
                    </svg>
                    ëª©ë¡ìœ¼ë¡œ
                </button>
            </div>

        </article>

        <!-- âœ… ëŒ“ê¸€ ì„¹ì…˜ -->
        <aside class="comments-section" id="comments">
            <div class="comments-sticky-wrapper">

                <!-- ===== ìŠ¤í‹°ì»¤ ë¶™ì´ê¸° íŒ¨ë„ ===== -->
                <div class="decoration-panel mb-8 p-6 bg-[#F9F6F1] rounded-2xl">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="text-xl">âœ¨</span>
                        <h3 class="text-[#8B7355] font-serif text-lg font-bold">ìŠ¤í‹°ì»¤ ë¶™ì´ê¸°</h3>
                    </div>

                    <div id="deco-start-view">
                        <button onclick="startDecoration()"
                                class="w-full py-3 bg-[#D4C4B0] text-white rounded-xl hover:bg-[#C9B5A0] transition-all font-medium cursor-pointer">
                            ìŠ¤í‹°ì»¤ ë¶™ì´ê¸° ì‹œì‘
                        </button>
                    </div>

                    <div id="deco-active-view" class="hidden space-y-4 animate-fade-in">
                        <div class="flex flex-col gap-3">
                            <p class="text-xs text-[#8B7355] font-medium flex items-center gap-1">
                                <span class="animate-pulse">ğŸ’¡</span> ìŠ¤í‹°ì»¤ë¥¼ ì´ë¯¸ì§€ ìœ„ë¡œ ë“œë˜ê·¸í•˜ì„¸ìš”!
                            </p>



                            <div class="relative group">
                                <button type="button" class="tab-scroll-btn left-0" onclick="document.getElementById('sticker-category-tabs').scrollLeft -= 150">â€¹</button>
                                <div id="sticker-category-tabs"
                                     class="flex gap-2 overflow-x-auto pb-2 scrollbar-hide border-b border-[#E8D5C4]"></div>
                                <button type="button" class="tab-scroll-btn right-0" onclick="document.getElementById('sticker-category-tabs').scrollLeft += 150">â€º</button>
                            </div>

                            <div id="sticker-palette"
                                 class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 xl:grid-cols-10 2xl:grid-cols-12 gap-3 bg-white p-4 rounded-2xl min-h-[160px] max-h-[300px] overflow-y-auto border border-[#E8D5C4] shadow-inner scrollbar-hide"></div>
                        </div>

                        <div class="flex flex-col gap-2 pt-2">
                            <button onclick="clearAllStickers()"
                                    class="w-full py-2 bg-red-50 text-red-500 rounded-lg text-xs font-bold hover:bg-red-100 transition-all border border-red-100">
                                ğŸ—‘ï¸ ìŠ¤í‹°ì»¤ ëª¨ë‘ ì§€ìš°ê¸°
                            </button>
                            <div class="flex gap-2">
                                <button onclick="saveDecoration()"
                                        class="flex-1 py-3 bg-[#8B7355] text-white rounded-xl font-bold shadow-sm">
                                    âœ¨ ì €ì¥í•˜ê¸°
                                </button>
                                <button onclick="cancelDecoration()"
                                        class="flex-1 py-3 bg-[#E8D5C4] text-[#8B7355] rounded-lg font-bold">
                                    ì·¨ì†Œ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ëŒ“ê¸€ íƒ€ì´í‹€ -->
                <h2 class="comments-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                         viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <span id="comment-count-text"
                          th:text="'ëŒ“ê¸€ ' + ${(commentsPage != null) ? commentsPage.totalElements : 0} + 'ê°œ'">
              ëŒ“ê¸€ 0ê°œ
            </span>
                </h2>

                <!-- ëŒ“ê¸€ ì‘ì„± í¼ -->
                <form id="comment-form"
                      class="comment-form"
                      th:data-post-id="${post.id}"
                      th:action="@{/comments}"
                      method="post">
                    <input type="hidden" name="postId" th:value="${post.id}">
                    <textarea id="comment-content" name="content"
                              placeholder="ë”°ëœ»í•œ ëŒ“ê¸€ì„ ë‚¨ê²¨ì£¼ì„¸ìš”..."
                              class="comment-textarea"
                              maxlength="500"></textarea>

                    <div class="comment-form-footer">
                        <span id="comment-char-count" class="char-count">0/500</span>
                        <button type="submit" class="btn-submit-comment">ë“±ë¡</button>
                    </div>
                </form>

                <!-- ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ -->
                <div id="comments-list" class="comments-list">
                    <div th:if="${comments == null or #lists.isEmpty(comments)}" class="no-comments">
                        ì•„ì§ ëŒ“ê¸€ì´ ì—†ì–´ìš”. ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!
                    </div>

                    <div class="comment-item"
                         th:each="c : ${comments}"
                         th:attr="data-comment-id=${c.id}"
                         th:id="'comment-' + ${c.id}">
                        <div class="comment-card">
                            <div class="comment-content-view">
                                <p class="comment-text" th:text="${c.content}">ëŒ“ê¸€ ë‚´ìš©</p>

                                <div class="comment-bottom-row">
                                    <div class="comment-left-meta">
                                        <span class="comment-author" th:text="${c.authorNickname}">ì‘ì„±ì</span>
                                        <span class="comment-date"
                                              th:text="${#temporals.format(c.createdAt, 'yyyyë…„ Mì›” dì¼')}">
                        2026ë…„ 1ì›” 12ì¼
                      </span>
                                    </div>

                                    <div class="comment-actions">
                                        <button type="button"
                                                class="icon-btn btn-comment-edit"
                                                title="ìˆ˜ì •"
                                                th:if="${c.canEdit}">
                                            âœï¸
                                        </button>

                                        <form th:if="${c.canEdit}"
                                              th:action="@{/comments/{id}/delete(id=${c.id})}"
                                              method="post"
                                              class="inline-form">
                                            <input type="hidden" name="page" th:value="${commentsPage != null ? commentsPage.number : 0}">
                                            <input type="hidden" name="size" th:value="${commentsPage != null ? commentsPage.size : 5}">
                                            <button type="submit" class="icon-btn btn-comment-delete" title="ì‚­ì œ">ğŸ—‘ï¸</button>
                                        </form>

                                        <button type="button" class="icon-btn btn-comment-report" title="ì‹ ê³ ">âš ï¸</button>
                                    </div>
                                </div>
                            </div>

                            <div class="comment-edit-box hidden">
                                <form th:action="@{/comments/{id}/edit(id=${c.id})}" method="post">
                                    <input type="hidden" name="page" th:value="${commentsPage != null ? commentsPage.number : 0}">
                                    <input type="hidden" name="size" th:value="${commentsPage != null ? commentsPage.size : 5}">
                                    <textarea class="comment-edit-textarea" name="content"
                                              maxlength="500"
                                              th:text="${c.content}"></textarea>
                                    <div class="comment-edit-actions">
                                        <button type="submit" class="btn-edit-save">ì €ì¥</button>
                                        <button type="button" class="btn-edit-cancel">ì·¨ì†Œ</button>
                                    </div>
                                </form>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- ëŒ“ê¸€ í˜ì´ì§• -->
                <div class="comment-pagination"
                     th:if="${commentsPage != null and commentsPage.totalPages > 1}"
                     th:attr="data-post-id=${post.id}">
                    <button type="button" class="btn-page"
                            th:if="${commentsPage.hasPrevious()}"
                            th:attr="data-page=${commentsPage.number - 1}, data-size=${commentsPage.size}">
                        ì´ì „
                    </button>

                    <th:block th:each="p : ${#numbers.sequence(0, commentsPage.totalPages - 1)}">
                        <button type="button"
                                class="btn-page page-number"
                                th:classappend="${commentsPage.number == p} ? ' active' : ''"
                                th:attr="data-page=${p}, data-size=${commentsPage.size}"
                                th:text="${p + 1}">
                            1
                        </button>
                    </th:block>

                    <button type="button" class="btn-page"
                            th:if="${commentsPage.hasNext()}"
                            th:attr="data-page=${commentsPage.number + 1}, data-size=${commentsPage.size}">
                        ë‹¤ìŒ
                    </button>
                </div>

            </div>
        </aside>
    </div>
</main>

<!-- scripts -->
<script th:src="@{/js/main.js}"></script>
<script th:src="@{/js/comment.js}"></script>
<script th:src="@{/js/post.js}"></script>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script th:inline="javascript">
    window.ST_DATA = {
        postId: [[${post.id}]],
        currentUserId: [[${session.loginUser != null ? session.loginUser.loginId : ''}]],
        currentUserNickname: [[${session.loginUser != null ? session.loginUser.nickname : ''}]],
        rawUserId: [[${session.loginUser != null ? session.loginUser.userId : ''}]],
        postOwnerId: [[${post.author.loginId}]]
    };
</script>

<script th:src="@{/js/sticker.js}"></script>

<script src="https://cdn.jsdelivr.net/npm/swiper@12/swiper-bundle.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {

        // 1. ê²Œì‹œê¸€ ì‹ ê³  ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
        const postReportBtn = document.querySelector('.btn-post-report');
        if (postReportBtn) {
            postReportBtn.addEventListener('click', function() {
                const postId = this.getAttribute('data-post-id');
                const reason = prompt("ê²Œì‹œê¸€ ì‹ ê³  ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”:");

                if (!reason) return; // ì·¨ì†Œ ì‹œ ì¤‘ë‹¨
                if (reason.trim() === "") return alert("ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");

                // FormData í˜•íƒœë¡œ ì „ì†¡ (ì»¨íŠ¸ë¡¤ëŸ¬ì˜ @RequestParamì— ë§ì¶¤)
                const params = new URLSearchParams();
                params.append('postId', postId);
                params.append('reason', reason);

                axios.post('/post/report', params)
                    .then(res => alert(res.data))
                    .catch(err => {
                        if(err.response && err.response.status === 401) alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                        else alert("ì‹ ê³  ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    });
            });
        }

        // 2. ëŒ“ê¸€ ì‹ ê³  ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²° (ë™ì  ë¦¬ìŠ¤íŠ¸ ëŒ€ì‘)
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('btn-comment-report') || e.target.closest('.btn-comment-report')) {
                const btn = e.target.classList.contains('btn-comment-report') ? e.target : e.target.closest('.btn-comment-report');
                const commentItem = btn.closest('.comment-item');
                const commentId = commentItem.getAttribute('data-comment-id');

                const reason = prompt("ëŒ“ê¸€ ì‹ ê³  ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”:");
                if (!reason) return;
                if (reason.trim() === "") return alert("ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");

                const params = new URLSearchParams();
                params.append('commentId', commentId);
                params.append('reason', reason);

                axios.post('/comment/report', params)
                    .then(res => alert(res.data))
                    .catch(err => {
                        if(err.response && err.response.status === 401) alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                        else alert("ì‹ ê³  ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                    });
            }
        });
    });
</script>

<script>
    (function () {
        const root = document.querySelector(".postImagesSwiper");
        if (!root) return;

        const swiper = new Swiper(root, {
            slidesPerView: 1,
            spaceBetween: 0,
            centeredSlides: false,
            watchOverflow: true,
            touchStartPreventDefault: false,
            preventClicks: false,
            preventClicksPropagation: false,
            observer: true,
            observeParents: true,
            pagination: {
                el: root.querySelector(".swiper-pagination"),
                clickable: true,
            },
            navigation: {
                nextEl: root.querySelector(".swiper-button-next"),
                prevEl: root.querySelector(".swiper-button-prev"),
            },
        });

        root.querySelectorAll("img").forEach(img => {
            if (img.complete) return;
            img.addEventListener("load", () => swiper.update(), { once: true });
        });
    })();
</script>
</body>
</html>