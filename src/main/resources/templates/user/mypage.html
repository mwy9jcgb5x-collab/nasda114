<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout/header :: head}"></head>

<body class="bg-[#F9F6F1]">
<div th:replace="~{layout/header :: header}"></div>

<main class="max-w-6xl mx-auto py-12 px-6 flex gap-10">
    <aside class="w-64 shrink-0 space-y-3">
        <h2 class="text-lg font-bold text-[#5A4D41] mb-6 px-2">ë§ˆì´í˜ì´ì§€</h2>

        <button onclick="switchTab('activity')" id="tab-btn-activity"
                class="w-full flex justify-between items-center p-4 rounded-xl transition-all bg-[#D4C4B0] text-white shadow-sm">
            <span class="font-medium">âœ¨ ë‚˜ì˜ í™œë™</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
        </button>

        <button onclick="switchTab('account')" id="tab-btn-account"
                class="w-full flex justify-between items-center p-4 rounded-xl transition-all bg-white text-[#8B7355] border border-[#E8D5C4]/50 hover:bg-[#F2ECE4]">
            <span class="font-medium">âš™ï¸ ê³„ì • ê´€ë¦¬</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
        </button>

        <button onclick="switchTab('reports')" id="tab-btn-reports"
                class="w-full flex justify-between items-center p-4 rounded-xl transition-all bg-white text-[#8B7355] border border-[#E8D5C4]/50 hover:bg-[#F2ECE4]">
            <span class="font-medium">ğŸš¨ ì‹ ê³  ë‚´ì—­</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
            </svg>
        </button>
    </aside>

    <section class="flex-1 min-h-[600px]">

        <div id="content-activity" class="space-y-6">
            <h3 class="text-xl font-bold text-[#5A4D41] mb-6">ë‚˜ì˜ í™œë™</h3>

            <div class="grid grid-cols-3 gap-4">
                <div th:onclick="|location.href='@{/posts/my}'|"
                     class="bg-white p-6 rounded-2xl border border-[#E8D5C4]/30 shadow-sm cursor-pointer hover:bg-[#F2ECE4] transition-all">
                    <p class="text-[#A89080] text-sm mb-2">ì‘ì„±í•œ ê²Œì‹œë¬¼</p>
                    <p class="text-2xl font-bold text-[#5A4D41]">
                        <span th:text="${postCount != null ? postCount : 0}">0</span>
                        <span class="text-base ml-1">ê°œ</span>
                    </p>
                </div>

                <div th:onclick="|location.href='@{/comments/my}'|"
                     class="bg-white p-6 rounded-2xl border border-[#E8D5C4]/30 shadow-sm cursor-pointer hover:bg-[#F2ECE4] transition-all">
                    <p class="text-[#A89080] text-sm mb-2">ì‘ì„±í•œ ëŒ“ê¸€</p>
                    <p class="text-2xl font-bold text-[#5A4D41]">
                        <span th:text="${commentCount != null ? commentCount : 0}">0</span>
                        <span class="text-base ml-1">ê°œ</span>
                    </p>
                </div>
            </div>
            <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

            <div id="calendar" class="mb-8 bg-white p-6 rounded-2xl shadow-sm"></div>

            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    var calendarEl = document.getElementById('calendar');
                    var calendar = new FullCalendar.Calendar(calendarEl, {
                        initialView: 'dayGridMonth',
                        locale: 'ko',
                        height: 'auto',
                        headerToolbar: { left: 'prev,next today', center: 'title', right: '' },
                        events: '/api/posts/my/calendar',

                        eventContent: function(arg) {
                            let imageUrl = arg.event.extendedProps.image;
                            if (imageUrl) {
                                // âœ… ì—‘ë°• ë°©ì§€ í•µì‹¬: ì£¼ì†Œ ì•ì— /ê°€ ì—†ìœ¼ë©´ ê°•ì œë¡œ ë¶™ì—¬ì¤ë‹ˆë‹¤.
                                let safeUrl = imageUrl.startsWith('/') ? imageUrl : '/' + imageUrl;

                                return {
                                    html: `<div class="calendar-post-img-wrapper" style="width: 100%; height: 100%;">
                                 <img src="${safeUrl}" class="calendar-event-img"
                                      style="width: 100%; aspect-ratio: 1/1; object-fit: cover; border-radius: 6px;">
                               </div>`
                                };
                            }
                        },
                        eventClick: function(info) {
                            if (info.event.url) {
                                window.location.href = info.event.url;
                                info.jsEvent.preventDefault();
                            }
                        }
                    });
                    calendar.render();
                });
            </script>

            <style>
                /* ìº˜ë¦°ë” ì „ì²´ í‹€ */
                #calendar {
                    max-width: 1000px;
                    margin: 20px auto;
                    padding: 20px;
                    background-color: #F9F6F1;
                    border-radius: 24px;
                    border: 1px solid #E8D5C4;
                }

                /* [í•µì‹¬] ì´ë¯¸ì§€ë¥¼ ê°€ë¡œë¡œ ë‚˜ì—´í•˜ê²Œ ë§Œë“œëŠ” ì„¤ì • */
                .fc-event-main {
                    display: flex !important;
                    flex-direction: row !important; /* ê°€ë¡œ ì •ë ¬ */
                    flex-wrap: wrap !important;    /* ì¹¸ ëª¨ìë¼ë©´ ë‹¤ìŒ ì¤„ë¡œ */
                    justify-content: flex-start !important;
                    gap: 4px !important;           /* ì´ë¯¸ì§€ ì‚¬ì´ ê°„ê²© */
                    background: transparent !important;
                }

                /* ì´ë¯¸ì§€ í¬ê¸° ì¡°ì ˆ */
                .calendar-event-img {
                    width: 35px !important;  /* ê°€ë¡œë¡œ ì—¬ëŸ¬ ê°œ ë³´ì¼ ìˆ˜ ìˆê²Œ í¬ê¸° ì¶•ì†Œ */
                    height: 35px !important;
                    aspect-ratio: 1/1;
                    object-fit: cover;
                    border-radius: 4px;
                    border: 1px solid #fff;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                }

                /* ìº˜ë¦°ë” ì´ë²¤íŠ¸ ë°•ìŠ¤ ë°°ê²½ ì œê±° */
                .fc-event {
                    background: transparent !important;
                    border: none !important;
                }

                /* ë‚ ì§œ ìˆ«ì ìœ„ì¹˜ ê³ ì • */
                .fc-daygrid-day-top {
                    flex-direction: row !important;
                    justify-content: flex-end;
                }
            </style>

            <div class="mt-10">
                <h4 class="text-[#8B7355] font-semibold mb-4">ìµœê·¼ ì‘ì„±í•œ ê²Œì‹œë¬¼</h4>

                <div class="grid grid-cols-2 gap-4"
                     th:if="${myPosts != null and !myPosts.isEmpty()}">

                    <div th:each="post : ${myPosts}"
                         th:if="${post != null}"
                         th:onclick="|location.href='/posts/' + ${post.id}|"
                         class="bg-white rounded-xl overflow-hidden border border-[#E8D5C4]/20 shadow-sm cursor-pointer hover:shadow-md transition-all">

                        <img th:if="${post.images != null and !post.images.isEmpty()}"
                             th:src="@{${post.images[0]}}"
                             class="w-full h-32 object-cover"/>
                        <div th:unless="${post.images != null and !post.images.isEmpty()}"
                             class="w-full h-32 bg-[#F2ECE4] flex items-center justify-center text-[#A89080] text-xs">
                            No Image
                        </div>

                        <div class="p-4">
                            <p class="font-medium text-[#5A4D41] truncate"
                               th:text="${post.title}">ì œëª©</p>
                            <p class="text-xs text-[#A89080]"
                               th:text="${#temporals.format(post.createdAt, 'yyyy.MM.dd')}">ë‚ ì§œ</p>
                        </div>
                    </div>
                </div>

                <div th:if="${myPosts == null or myPosts.isEmpty()}"
                     class="py-20 text-center bg-white rounded-2xl border border-dashed border-[#E8D5C4]">
                    <p class="text-[#A89080]">ì•„ì§ ì‘ì„±í•œ ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>
        <div id="content-reports" class="hidden space-y-6">
            <h3 class="text-xl font-bold text-[#5A4D41] mb-6">ğŸš¨ ì‹ ê³  ë‚´ì—­</h3>
            <div class="space-y-4">
                <div th:each="reason : ${dummyReports}"
                     class="bg-white p-6 rounded-2xl border border-red-100 shadow-sm flex flex-col gap-3">
                    <div class="flex justify-between items-start">
                        <div>
                            <span class="inline-block px-2 py-0.5 rounded text-[10px] font-bold bg-red-50 text-red-500 mb-2">ì‹ ê³  ì ‘ìˆ˜</span>
                            <h3 class="text-lg font-bold text-[#5A4D41]" th:text="${reason}">ë”ë¯¸ ì‚¬ìœ </h3>
                        </div>
                        <span class="text-xs font-medium px-3 py-1 rounded-full bg-gray-100 text-gray-500">ê²€í†  ëŒ€ê¸°ì¤‘</span>
                    </div>
                    <div class="flex justify-between items-end border-t border-gray-50 pt-3">
                        <p class="text-xs text-[#A89080]">2026.01.16</p>
                        <span class="text-xs font-bold text-[#A89080]">ìƒì„¸ë³´ê¸° ì¤€ë¹„ì¤‘</span>
                    </div>
                </div>

                <div th:if="${dummyReports == null or dummyReports.isEmpty()}"
                     class="py-20 text-center bg-white rounded-2xl border border-dashed border-[#E8D5C4]">
                    <p class="text-[#A89080]">í˜„ì¬ ì‹ ê³ ëœ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤. ğŸ˜Š</p>
                </div>
            </div>
        </div>

        <div id="content-account" class="hidden space-y-6">
            <h3 class="text-xl font-bold text-[#5A4D41] mb-6">ê³„ì • ê´€ë¦¬</h3>

            <form th:action="@{/user/mypage/update}" method="post" onsubmit="return validateForm()"
                  class="bg-white p-8 rounded-2xl border border-[#E8D5C4]/30 shadow-sm space-y-6">
                <div>
                    <label class="block text-xs text-[#A89080] mb-1">ì•„ì´ë””</label>
                    <div class="p-4 bg-[#F9F6F1] rounded-xl text-[#5A4D41] font-medium"
                         th:text="${user != null ? user.loginId : 'N/A'}">userid
                    </div>
                </div>

                <div>
                    <label class="block text-xs text-[#A89080] mb-1">ë‹‰ë„¤ì„ ìˆ˜ì •</label>
                    <div class="flex gap-2">
                        <input type="text" id="nickname" name="nickname"
                               th:value="${user != null ? user.nickname : ''}"
                               oninput="resetNicknameCheck()"
                               class="flex-1 p-4 bg-[#F9F6F1] rounded-xl text-[#5A4D41] border-none focus:ring-1 focus:ring-[#D4C4B0]">

                        <button type="button" onclick="checkNickname()"
                                class="px-4 py-2 bg-[#8B7355] text-white rounded-xl text-sm font-medium hover:bg-[#6d6158] transition-colors">
                            ì¤‘ë³µ í™•ì¸
                        </button>
                    </div>
                    <p id="nicknameCheck" class="text-[10px] mt-1 ml-1" style="min-height: 15px;"></p>
                </div>

                <div>
                    <label class="block text-xs text-[#A89080] mb-1">ì´ë©”ì¼</label>
                    <input type="email" name="email"
                           th:value="${user != null ? user.email : ''}"
                           readonly
                           class="w-full p-4 bg-[#F9F6F1] rounded-xl text-[#8B7355] border-none cursor-not-allowed">
                </div>

                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

                <div class="password-management" í˜="margin-top: 40px !important;">
                    <div style="border-top: 1px dashed #e2ddd9 !important; margin-bottom: 35px !important;"></div>

                    <h3 style="font-family: 'Pretendard', sans-serif !important; font-size: 20px !important; color: #4a4a4a !important; margin-bottom: 25px !important; font-weight: 600 !important;">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>

                    <div class="form-group" style="margin-bottom: 20px !important;">
                        <label class="form-label" style="display: block !important; font-size: 13px !important; color: #8c8c8c !important; margin-bottom: 10px !important;">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                        <div class="input-with-button" style="display: flex !important; gap: 10px !important;">
                            <div style="flex: 1; position: relative;">
                                <input type="password" id="newPassword" class="form-input"
                                       style="width: 100% !important; padding: 20px !important; border: none !important; border-radius: 12px !important; background-color: #f6f3f0 !important; font-size: 15px !important; color: #4a4a4a !important;"
                                       placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
                                <i class="fa-regular fa-eye" id="toggleNewPw"
                                   onclick="togglePwVisibility('newPassword', 'toggleNewPw')"
                                   style="position: absolute; right: 18px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #b0b0b0;"></i>
                            </div>
                            <div style="width: 100px;"></div>
                        </div>
                    </div>

                    <div class="form-group" style="margin-bottom: 10px !important;">
                        <label class="form-label" style="display: block !important; font-size: 13px !important; color: #8c8c8c !important; margin-bottom: 10px !important;">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                        <div class="input-with-button" style="display: flex !important; gap: 10px !important;">
                            <div style="flex: 1; position: relative;">
                                <input type="password" id="confirmPassword" class="form-input"
                                       style="width: 100% !important; padding: 20px !important; border: none !important; border-radius: 12px !important; background-color: #f6f3f0 !important; font-size: 15px !important; color: #4a4a4a !important;"
                                       placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸">
                                <i class="fa-regular fa-eye" id="toggleConfirmPw"
                                   onclick="togglePwVisibility('confirmPassword', 'toggleConfirmPw')"
                                   style="position: absolute; right: 18px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #b0b0b0;"></i>
                            </div>
                            <button type="button" class="btn-check" onclick="updatePassword()"
                                    style="width: 100px !important; background-color: #6d6158 !important; color: white !important; border: none !important; border-radius: 12px !important; font-weight: bold !important; cursor: pointer !important; font-size: 15px !important;">
                                ë³€ê²½
                            </button>
                        </div>
                    </div>

                    <p id="pw-msg" style="text-align: left !important; font-size: 12px !important; margin-left: 5px !important; color: #e74c3c !important; min-height: 20px !important;"></p>
                </div>


                <div class="pt-4 border-t border-[#E8D5C4]/20">
                    <label class="block text-xs text-red-400 mb-1 font-bold italic underline">ë³´ì•ˆ í™•ì¸: í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" name="currentPassword" id="currentPassword" required
                           placeholder="ì •ë³´ ìˆ˜ì •ì„ ìœ„í•´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”"
                           class="w-full p-4 bg-[#FFFBF8] rounded-xl text-[#5A4D41] border border-red-100 focus:ring-1 focus:ring-red-200 outline-none">

                    <p id="passwordError" class="text-[10px] mt-1 ml-1" style="color: #e74c3c; min-height: 15px;"></p>
                </div>

                <button type="submit"
                        class="w-full py-4 bg-[#D4C4B0] text-white font-semibold rounded-xl hover:bg-[#C9B5A0] transition-colors shadow-sm">
                    í”„ë¡œí•„ ìˆ˜ì • ì™„ë£Œ
                </button>
            </form>

            <div class="bg-white p-8 rounded-2xl border border-[#E8D5C4]/30 shadow-sm">
                <div class="pt-2">
                    <p class="text-red-400 text-sm font-bold mb-3 flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                        ìœ„í—˜ ì˜ì—­
                    </p>

                    <form th:action="@{/user/mypage/delete}" method="post">

                        <div class="mb-4">
                            <label class="block text-sm text-[#8B7355] mb-2 font-bold">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>

                            <input type="password"
                                   name="password"
                                   placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                                   required
                                   class="w-full p-3 border border-[#E8D5C4] rounded-xl focus:outline-none focus:ring-1 focus:ring-[#8B7355]">
                        </div>

                        <button type="submit"
                                class="w-full py-3 bg-red-400 text-white rounded-xl font-bold hover:bg-red-500 transition-all"
                                onclick="return confirm('ì •ë§ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                            íƒˆí‡´ ì‹œ ëª¨ë“  ë°ì´í„°ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.
                        </button>

                    </form>
                </div>
            </div>
        </div>
        </div>
    </section>
</main>

<script th:inline="javascript">
    function switchTab(tabName) {
        const activityContent = document.getElementById('content-activity');
        const accountContent = document.getElementById('content-account');
        const reportsContent = document.getElementById('content-reports');

        const activityBtn = document.getElementById('tab-btn-activity');
        const accountBtn = document.getElementById('tab-btn-account');
        const reportsBtn = document.getElementById('tab-btn-reports');

        const activeClass = "w-full flex justify-between items-center p-4 rounded-xl transition-all bg-[#D4C4B0] text-white shadow-sm";
        const inactiveClass = "w-full flex justify-between items-center p-4 rounded-xl transition-all bg-white text-[#8B7355] border border-[#E8D5C4]/50 hover:bg-[#F2ECE4]";

        if (tabName === 'activity') {
            activityContent.classList.remove('hidden');
            accountContent.classList.add('hidden');
            reportsContent.classList.add('hidden');
            activityBtn.className = activeClass;
            accountBtn.className = inactiveClass;
            reportsBtn.className = inactiveClass;
        } else if (tabName === 'reports') {
            activityContent.classList.add('hidden');
            accountContent.classList.add('hidden');
            reportsContent.classList.remove('hidden');
            activityBtn.className = inactiveClass;
            accountBtn.className = inactiveClass;
            reportsBtn.className = activeClass;
        } else {
            activityContent.classList.add('hidden');
            accountContent.classList.remove('hidden');
            reportsContent.classList.add('hidden');
            accountBtn.className = activeClass;
            activityBtn.className = inactiveClass;
            reportsBtn.className = inactiveClass;
        }
    }

    function updatePassword() {
        const currentPw = document.querySelector('input[name="currentPassword"]').value;
        const newPw = document.getElementById('newPassword').value;
        const confirmPw = document.getElementById('confirmPassword').value;
        const msg = document.getElementById('pw-msg');

        if (!currentPw) {
            msg.innerText = "âœ— í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì•¼ ë³€ê²½ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤."; // alert ëŒ€ì‹  ë©”ì‹œì§€
            return;
        }
        if (!newPw || newPw.length < 6) {
            msg.innerText = "âœ— ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”."; // alert ëŒ€ì‹  ë©”ì‹œì§€
            return;
        }
        if (newPw !== confirmPw) {
            msg.innerText = "âœ— ë¹„ë°€ë²ˆí˜¸ í™•ì¸ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
            msg.style.color = "red";
            return;
        }

        const formData = new URLSearchParams();
        formData.append('currentPassword', currentPw);
        formData.append('newPassword', newPw);

        fetch('/user/mypage/change-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: formData
        })
            .then(res => {
                if (res.ok) {
                    alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. ë³´ì•ˆì„ ìœ„í•´ ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                    location.href = "/user/logout";
                } else if (res.status === 400) {
                    msg.innerText = "âœ— í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤."; // alert ëŒ€ì‹  ë©”ì‹œì§€
                } else {
                    msg.innerText = "âœ— ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
                }
            })
            .catch(err => console.error("Error:", err));
    }

    function togglePwVisibility(inputId, iconId) {
        const pwInput = document.getElementById(inputId);
        const icon = document.getElementById(iconId);

        if (pwInput.type === 'password') {
            pwInput.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
            icon.style.color = "#6d6158";
        } else {
            pwInput.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
            icon.style.color = "#ccc";
        }
    }

    let nicknameChecked = true;
    let nicknameAvailable = true;
    const originalNickname = /*[[${user.nickname}]]*/ '';

    async function checkNickname() {
        const nicknameInput = document.getElementById('nickname');
        const nickname = nicknameInput.value.trim();
        const checkElement = document.getElementById('nicknameCheck');

        if (nickname === originalNickname) {
            checkElement.innerText = 'âœ“ í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.';
            checkElement.style.color = '#2ecc71';
            nicknameChecked = true;
            nicknameAvailable = true;
            return;
        }

        const nicknameRegex = /^[ê°€-í£a-zA-Z0-9]{2,10}$/;
        if (!nicknameRegex.test(nickname)) {
            checkElement.innerText = 'ë‹‰ë„¤ì„ì€ í•œê¸€, ì˜ë¬¸, ìˆ«ì 2~10ìë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.';
            checkElement.style.color = '#e74c3c';
            nicknameChecked = false;
            return;
        }

        try {
            const response = await fetch(`/user/check-nickname?nickname=${encodeURIComponent(nickname)}`);
            const isDuplicate = await response.json();
            nicknameChecked = true;
            nicknameAvailable = !isDuplicate;

            if (isDuplicate) {
                checkElement.innerText = 'âœ— ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.';
                checkElement.style.color = '#e74c3c';
            } else {
                checkElement.innerText = 'âœ“ ì‚¬ìš© ê°€ëŠ¥í•œ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.';
                checkElement.style.color = '#2ecc71';
            }
        } catch (e) {
            checkElement.innerText = 'í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            checkElement.style.color = '#e74c3c';
        }
    }

    // âœ… ì¤‘ë³µëœ í•¨ìˆ˜ë¥¼ í•˜ë‚˜ë¡œ í†µí•©í•˜ê³  alertë¥¼ í…ìŠ¤íŠ¸ë¡œ ë³€ê²½
    function validateForm() {
        const checkElement = document.getElementById('nicknameCheck');
        const pwErrorElement = document.getElementById('passwordError');
        const currentPwInput = document.getElementById('currentPassword');

        // 1. ë‹‰ë„¤ì„ ê²€ì¦ ë¯¸ì‹¤ì‹œ ì‹œ í…ìŠ¤íŠ¸ ì¶œë ¥
        if (!nicknameChecked || !nicknameAvailable) {
            checkElement.innerText = "âœ— ë‹‰ë„¤ì„ ì¤‘ë³µ í™•ì¸ì„ ì™„ë£Œí•´ ì£¼ì„¸ìš”.";
            checkElement.style.color = "#e74c3c";
            document.getElementById('nickname').focus();
            return false; // ì „ì†¡ ì°¨ë‹¨
        }

        // 2. í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ ë¯¸ì…ë ¥ ì‹œ í…ìŠ¤íŠ¸ ì¶œë ¥
        if (!currentPwInput.value.trim()) {
            if (pwErrorElement) {
                pwErrorElement.innerText = "âœ— í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.";
                pwErrorElement.style.color = "#e74c3c";
            }
            currentPwInput.focus();
            return false;
        }

        return true;
    }

    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('tab') === 'account') { switchTab('account'); }

        // âœ… ì„œë²„ ì—ëŸ¬(ë¹„ë°€ë²ˆí˜¸ í‹€ë¦¼ ë“±) ë°œìƒ ì‹œ ëª¨ë‹¬ ëŒ€ì‹  í…ìŠ¤íŠ¸ ì¶œë ¥
        const errorMsg = /*[[${errorMessage}]]*/ null;
        const passwordErrorElement = document.getElementById('passwordError');

        if (errorMsg && errorMsg !== "null" && errorMsg !== "") {
            if (passwordErrorElement) {
                passwordErrorElement.innerText = "âœ— " + errorMsg;
                passwordErrorElement.style.color = "#e74c3c";
            }
            document.getElementById('currentPassword').style.borderColor = "#e74c3c";
            switchTab('account');
        }

        // í¼ ì „ì†¡ ì‹œ ìµœì¢… ê²€ì¦ ì—°ê²°
        const profileForm = document.querySelector('form[th\\:action*="update"]');
        if (profileForm) {
            profileForm.onsubmit = validateForm;
        }
    });

    function resetNicknameCheck() {
        const nickname = document.getElementById('nickname').value.trim();
        const checkElement = document.getElementById('nicknameCheck');
        if (nickname !== originalNickname) {
            nicknameChecked = false;
            nicknameAvailable = false;
            checkElement.innerText = "ë‹‰ë„¤ì„ ë³€ê²½ ì‹œ ì¤‘ë³µ í™•ì¸ì´ ë‹¤ì‹œ í•„ìš”í•©ë‹ˆë‹¤.";
            checkElement.style.color = "#A89080";
        } else {
            nicknameChecked = true;
            nicknameAvailable = true;
            checkElement.innerText = "âœ“ í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.";
            checkElement.style.color = "#2ecc71";
        }
    }
</script>

<div th:replace="~{layout/header :: commonScript}"></div>
</body>
</html>